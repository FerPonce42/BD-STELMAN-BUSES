{% extends 'publico/base.html' %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        .ruta-main { width: 90%; margin: 20px auto; display: flex; gap: 24px; align-items: flex-start; }
        .routes-map { flex: 1; display: flex; flex-direction: column; }
        .routes-map h3 { margin: 0 0 12px 0; color: #333; font-size: 18px; }
        .map-container { width: 100%; height: 700px !important; min-height: 700px !important; max-height: 700px !important; flex-shrink: 0; border-radius: 10px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,.15); }
        #map { width: 100%; height: 100%; display: block; }
        .info { width: 360px; height: 700px !important; background: #fff; padding: 18px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,.08); overflow-y: auto; }
        .titulo-ruta { font-size: 28px; margin: 0 0 6px 0; color: #1abc9c; }
        .descripcion { margin: 0 0 14px 0; color: #666; font-size: 14px; }
        .info h2 { margin-top: 12px; margin-bottom: 8px; font-size: 16px; color: #1abc9c; }
        .info ul { padding-left: 20px; margin: 0; }
        .info ul li { margin: 6px 0; font-size: 14px; color: #555; }
        @media (max-width: 900px) { .ruta-main { flex-direction: column; align-items: stretch; } .info { width: 100%; height: auto; } .map-container { height: 400px; min-height: 400px; } }
    </style>
{% endblock %}

{% block content %}

<div class="ruta-main">
    <section class="routes-map">
        <h3>Mapa Interactivo</h3>
        <div id="map" class="map-container" data-paraderos='{{ paraderos_coords | default([]) | tojson | safe }}'></div>
    </section>

    <aside class="info">
        <h1 class="titulo-ruta">Ruta {{ codigo }}</h1>
        <p class="descripcion">Informaci√≥n detallada y aproximada del recorrido.</p>

        {% if codigo == 'A' %}
        <h2>üìç Recorrido Principal</h2>
        <ul>
            <li>Plaza de Armas ‚Üí Yanahuara ‚Üí Cayma</li>
            <li>Retorno por Av. Ej√©rcito y Real Plaza Arequipa</li>
            <li>Conexiones con rutas B y F</li>
        </ul>

        {% elif codigo == 'B' %}
        <h2>üìç Recorrido Principal</h2>
        <ul>
            <li>Paucarpata ‚Üí Av. Kennedy ‚Üí Palacio Metropolitano</li>
            <li>Retorno por Av. Independencia</li>
        </ul>

        {% elif codigo == 'C' %}
        <h2>üìç Recorrido Principal</h2>
        <ul>
            <li>Umacollo ‚Üí UNSA Ingenier√≠as ‚Üí Cercado</li>
            <li>Llega a Terminal Terrestre y Mall Aventura</li>
        </ul>

        {% elif codigo == 'D' %}
        <h2>üìç Recorrido Principal</h2>
        <ul>
            <li>Cerro Colorado ‚Üí Zamacola ‚Üí Maestro</li>
            <li>Termina en Av. La Marina</li>
        </ul>

        {% elif codigo == 'E' %}
        <h2>üìç Recorrido Principal</h2>
        <ul>
            <li>Saband√≠a ‚Üí Characato ‚Üí Cercado</li>
            <li>Ruta de mayor tr√°nsito</li>
        </ul>

        {% elif codigo == 'F' %}
        <h2>üìç Recorrido Principal</h2>
        <ul>
            <li>Tiabaya ‚Üí Hunter ‚Üí Cercado</li>
            <li>Conexi√≥n con Ruta A y C</li>
        </ul>
        {% endif %}
    </aside>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
    const codigo = '{{ codigo }}';
    const paraderos = {
        'A': [
            {nombre: 'Plaza de Armas', lat: -16.4090, lng: -71.5375},
            {nombre: 'Yanahuara', lat: -16.4120, lng: -71.5380},
            {nombre: 'Cayma', lat: -16.4180, lng: -71.5320}
        ],
        'B': [
            {nombre: 'Paucarpata', lat: -16.4005, lng: -71.5300},
            {nombre: 'Av. Kennedy', lat: -16.4020, lng: -71.5280},
            {nombre: 'Palacio Metropolitano', lat: -16.4080, lng: -71.5260}
        ],
        'C': [
            {nombre: 'Umacollo', lat: -16.3960, lng: -71.5360},
            {nombre: 'UNSA Ingenier√≠as', lat: -16.3980, lng: -71.5350},
            {nombre: 'Terminal Terrestre', lat: -16.4050, lng: -71.5330}
        ],
        'D': [
            {nombre: 'Cerro Colorado', lat: -16.3900, lng: -71.5400},
            {nombre: 'Zamacola', lat: -16.3920, lng: -71.5390},
            {nombre: 'Av. La Marina', lat: -16.3980, lng: -71.5380}
        ],
        'E': [
            {nombre: 'Saband√≠a', lat: -16.4080, lng: -71.5230},
            {nombre: 'Characato', lat: -16.4070, lng: -71.5230},
            {nombre: 'Cercado', lat: -16.4030, lng: -71.5210}
        ],
        'F': [
            {nombre: 'Tiabaya', lat: -16.4120, lng: -71.5300},
            {nombre: 'Hunter', lat: -16.4120, lng: -71.5290},
            {nombre: 'Cercado', lat: -16.4090, lng: -71.5270}
        ]
    };

    const datos = paraderos[codigo] || paraderos['A'];
    const latPromedio = datos.reduce((a, b) => a + b.lat, 0) / datos.length;
    const lngPromedio = datos.reduce((a, b) => a + b.lng, 0) / datos.length;

    // Crear mapa
    const map = L.map('map').setView([latPromedio, lngPromedio], 13);

    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // Agregar marcadores
    datos.forEach(p => {
        L.circleMarker([p.lat, p.lng], {
            radius: 8,
            fillColor: '#1abc9c',
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).bindPopup(p.nombre).addTo(map);
    });

    // Dibujar ruta (polil√≠nea)
    const coords = datos.map(p => [p.lat, p.lng]);
    L.polyline(coords, {
        color: '#1abc9c',
        weight: 4,
        opacity: 0.7
    }).addTo(map);

    // Forzar redimensionamiento antes de ajustar vista
    setTimeout(() => {
        map.invalidateSize(false);
        const group = new L.featureGroup(coords.map(c => L.marker(c)));
        map.fitBounds(group.getBounds().pad(0.1), { animate: false, duration: 0 });
    }, 100);
})();
</script>
{% endblock %}
