{% extends 'privado/base.html' %}

{% block title %}Caja | Stelman{% endblock %}

{% block content %}

<h1>๐ฐ Recaudaciรณn por Ruta</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
ย ย {% if messages %}
ย ย ย ย {% for category, message in messages %}
ย ย ย ย ย ย <div class="alert alert-{{ category }}">{{ message }}</div>
ย ย ย ย {% endfor %}
ย ย {% endif %}
{% endwith %}

<section style="display:flex; justify-content:flex-end; margin-bottom:15px;">
ย ย <a href="{{ url_for('panel_caja', nuevo_caja='true') }}#modal-registro-caja" class="btn btn-primary">
ย ย ย ย โ Registrar Recaudaciรณn
ย ย </a>
</section>

<hr>

<section>
ย ย <h2>Historial</h2>
ย ย <table border="1" width="100%" cellpadding="6">
ย ย ย ย <tr style="background:#f0f0f0;">
ย ย ย ย ย ย <th>Fecha</th>
ย ย ย ย ย ย <th>Monto</th>
ย ย ย ย ย ย <th>Empleado</th>
ย ย ย ย ย ย <th>Bus</th>
ย ย ย ย ย ย <th>Acciones</th>
ย ย ย ย </tr>
ย ย ย ย {% for c in cajas %}
ย ย ย ย <tr>
ย ย ย ย ย ย <td>{{ c.fecha }}</td>
ย ย ย ย ย ย <td>S/. {{ "%.2f"|format(c.monto_recaudado) }}</td>
ย ย ย ย ย ย <td>{{ c.nombre }} {{ c.apellido }}</td>
ย ย ย ย ย ย <td>{{ c.placa }}</td>
ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย <a href="{{ url_for('editar_caja', id_caja=c.id_caja) }}" class="btn-sm btn-info">โ๏ธ Editar</a>
ย ย ย ย ย ย ย ย <a href="{{ url_for('eliminar_caja', id_caja=c.id_caja) }}" class="btn-sm btn-warning"
ย ย ย ย ย ย ย ย ย ยonclick="return confirm('ยฟSeguro de eliminar esta recaudaciรณn?')">๐๏ธ Eliminar</a>
ย ย ย ย ย ย </td>
ย ย ย ย </tr>
ย ย ย ย {% else %}
ย ย ย ย <tr>
ย ย ย ย ย ย <td colspan="5" style="text-align:center;">โ No hay recaudaciones registradas.</td>
ย ย ย ย </tr>
ย ย ย ย {% endfor %}
ย ย </table>
</section>

{% if 'nuevo_caja' in request.args or editar_caja %}
<div id="modal-registro-caja" style="border:2px solid green; padding:20px;">
ย ย <h2>{% if editar_caja %}โ๏ธ Editar{% else %}โ Registrar{% endif %} Recaudaciรณn</h2>
ย ย <form method="post" action="{% if editar_caja %}{{ url_for('actualizar_caja') }}{% else %}{{ url_for('registrar_caja') }}{% endif %}">
ย ย ย ย {% if editar_caja %}
ย ย ย ย <input type="hidden" name="id_caja" value="{{ editar_caja.id_caja }}">
ย ย ย ย {% endif %}

ย ย ย ย <label>Fecha</label>
ย ย ย ย <input type="date" name="fecha" required max="{{ hoy }}" value="{{ editar_caja.fecha if editar_caja else '' }}">

ย ย ย ย <label>Monto</label>
ย ย ย ย <input type="number" step="0.01" name="monto" required value="{{ editar_caja.monto_recaudado if editar_caja else '' }}">

ย ย ย ย <label>Cobrador</label>
ย ย ย ย <select name="id_empleado" required>
ย ย ย ย ย ย {% for e in empleados %}
ย ย ย ย ย ย <option value="{{ e.id_empleado }}" {% if editar_caja and editar_caja.id_empleado == e.id_empleado %}selected{% endif %}>
ย ย ย ย ย ย ย ย {{ e.nombre }} {{ e.apellido }}
ย ย ย ย ย ย </option>
ย ย ย ย ย ย {% endfor %}
ย ย ย ย </select>

ย ย ย ย <label>Bus</label>
ย ย ย ย <select name="id_bus" required>
ย ย ย ย ย ย {% for b in buses %}
ย ย ย ย ย ย <option value="{{ b.id_bus }}" {% if editar_caja and editar_caja.id_bus == b.id_bus %}selected{% endif %}>
ย ย ย ย ย ย ย ย {{ b.placa }}
ย ย ย ย ย ย </option>
ย ย ย ย ย ย {% endfor %}
ย ย ย ย </select>

ย ย ย ย <label>Observaciรณn</label>
ย ย ย ย <textarea name="observacion">{{ editar_caja.observacion if editar_caja else '' }}</textarea>

ย ย ย ย <br><br>
ย ย ย ย <button type="submit">{% if editar_caja %}Actualizar{% else %}Guardar{% endif %}</button>
ย ย ย ย <a href="{{ url_for('panel_caja') }}" class="btn-sm">Cancelar</a>
ย ย </form>
</div>
{% endif %}

{% endblock %}