{% extends 'privado/base.html' %}

{% block title %}Gesti√≥n de Buses{% endblock %}

{% block content %}

<h1>Gesti√≥n de Buses</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<section style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
    <a href="{{ url_for('panel_buses', nuevo='true') }}#modal-registro" class="btn">‚ûï Nuevo</a> 
</section>

{% if bus_a_editar %}
    <div id="modal-edicion" style="border: 2px solid orange; padding: 20px; margin-top: 20px; margin-bottom: 20px;">
        <h2>‚úèÔ∏è Editar Bus: {{ bus_a_editar.placa }}</h2>

        <form method="post">
            <input type="hidden" name="id_bus_editado" value="{{ bus_a_editar.id_bus }}">

            <label>Placa</label>
            <input type="text" name="placa" value="{{ bus_a_editar.placa }}" required>

            <label>Modelo</label>
            <select name="id_modelo_bus" required>
                {% for m in modelos %}
                    <option value="{{ m.id }}" {% if m.id == bus_a_editar.id_modelo_bus %}selected{% endif %}>
                        {{ m.nombre }}
                    </option>
                {% endfor %}
            </select>

            <label>A√±o de fabricaci√≥n</label>
            <input type="number" name="anio" min="1950" max="2025" value="{{ bus_a_editar.a√±o_fabricacion }}" required>
            
            <label>√öltima Revisi√≥n (YYYY-MM-DD)</label>
            <input type="date" name="ultima_revision" value="{{ bus_a_editar.ultima_revision | default('', true) }}">

            <button type="submit">Guardar Cambios</button>
            <a href="{{ url_for('panel_buses') }}" class="btn-sm">Cancelar</a> 
        </form>
    </div>
{% endif %}
<section>
    <table border="1" width="100%" cellpadding="6">
        <tr>
            <th>ID</th> 
            <th>Placa</th>
            <th>Modelo</th>
            <th>Marca</th>
            <th>A√±o</th>
            <th>√öltima revisi√≥n</th>
            <th>Acciones</th> 
        </tr>

        {% for b in buses %}
        <tr>
            <td>{{ b.id_bus }}</td>
            <td>{{ b.placa }}</td>
            <td>{{ b.modelo }}</td>
            <td>{{ b.marca }}</td>
            <td>{{ b.a√±o }}</td>
            <td>{{ b.revision | default('N/A', true) }}</td>
            <td>
                <a href="{{ url_for('panel_buses', id_editar=b.id_bus) }}#modal-edicion" class="btn-sm">‚úèÔ∏è Editar</a>
                
                <a href="{{ url_for('panel_buses_eliminar', id_bus=b.id_bus) }}" class="btn-sm" 
                   onclick="return confirm('¬øSeguro que deseas desasignar el bus {{ b.placa }} de tu ruta?')">üóëÔ∏è Desasignar</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7" align="center">No hay buses registrados en tu ruta</td>
        </tr>
        {% endfor %}
    </table>
</section>

<div id="modal-registro" style="{% if 'nuevo' not in request.args %}display: none;{% endif %} border: 1px solid #ccc; padding: 20px; margin-top: 20px;">
    <h2>Registrar Nuevo Bus</h2>

    <form method="post">
        <label>Placa</label>
        <input type="text" name="placa" required>

        <label>Modelo</label>
        <select name="id_modelo_bus" required>
            {% for m in modelos %}
                <option value="{{ m.id }}">{{ m.nombre }}</option>
            {% endfor %}
        </select>

        <label>A√±o de fabricaci√≥n</label>
        <input type="number" name="anio" min="1950" max="2025" required>

        <button type="submit">Guardar</button>
        <a href="{{ url_for('panel_buses') }}" class="btn-sm">Cancelar</a> 
    </form>
</div>
{% endblock %}