{% extends 'privado/base.html' %}

{% block title %}Incidencias Disciplinarias{% endblock %}

{% block content %}

<h1>⚖️ Incidencias Disciplinarias</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Botón Nueva Incidencia -->
<section style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
    <a href="{{ url_for('panel_incidencias_disciplinarias', nuevo_incidencia='true') }}#modal-nueva" class="btn btn-primary">
        Nueva Incidencia Disciplinaria
    </a>
</section>

<hr>

<!-- Tabla de incidencias -->
<section>
    <h2>Incidencias Registradas</h2>

    <table border="1" width="100%" cellpadding="6">
        <tr style="background: #f0f0f0;">
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Tipo</th>
            <th>Sanción</th>
            <th>Estado</th>
            <th>Bus</th>
            <th style="text-align:right;">Acciones</th>
        </tr>

        {% for inc in incidencias %}
        <tr>
            <td>{{ inc.fecha }}</td>
            <td>{{ inc.descripcion }}</td>
            <td>{{ inc.tipo_disciplinaria }}</td>
            <td>{{ inc.sancion }}</td>
            <td>{{ inc.estado }}</td>
            <td>{{ inc.id_bus }}</td>
            <td style="text-align:right;">
                <a href="{{ url_for('panel_incidencias_disciplinarias', editar=inc.id_incidencia) }}#modal-editar" class="btn-sm btn-info">
                    Editar
                </a>
                <a href="{{ url_for('eliminar_incidencia_disciplinaria', id_incidencia=inc.id_incidencia) }}" 
                   class="btn-sm btn-warning"
                   onclick="return confirm('¿Seguro de eliminar esta incidencia disciplinaria?')">
                   Eliminar
                </a>
            </td>
        </tr>

        {% else %}
        <tr>
            <td colspan="7" style="text-align:center;">⚠ No hay incidencias disciplinarias.</td>
        </tr>
        {% endfor %}
    </table>
</section>

<hr style="margin-top: 40px; border-color: #333;">


{# ===================== NUEVA INCIDENCIA ===================== #}

{% if 'nuevo_incidencia' in request.args %}
<div id="modal-nueva" style="border:2px solid green; padding:20px;">

    <h2> Registrar Nueva Incidencia Disciplinaria</h2>

    <form method="post" action="{{ url_for('registrar_incidencia_disciplinaria') }}">

        <label>Fecha</label>
        <input type="date" name="fecha" required min="2000-01-01" max="{{ hoy }}">

        <label>Descripción</label>
        <textarea name="descripcion" rows="3" required></textarea>

        <label>Tipo Disciplinaria</label>
        <input type="text" name="tipo_disciplinaria" required>

        <label>Sanción</label>
        <input type="text" name="sancion" required>

        <!-- CAMBIO HECHO AQUÍ -->
        <label>Bus</label>
        <select name="id_bus" required>
            <option value="">-- Seleccionar bus --</option>
            {% for b in buses %}
                <option value="{{ b.id_bus }}">{{ b.placa }}</option>
            {% endfor %}
        </select>

        <label>Estado</label>
        <select name="estado" required>
            <option value="Pendiente">Pendiente</option>
            <option value="Resuelta">Resuelta</option>
            <option value="Cancelada">Cancelada</option>
        </select>

        <br><br>

        <button type="submit">Guardar</button>
        <a href="{{ url_for('panel_incidencias_disciplinarias') }}" class="btn-sm">Cancelar</a>
    </form>
</div>
{% endif %}


{# ===================== EDITAR INCIDENCIA ===================== #}

{% if editar_incidencia %}
<div id="modal-editar" style="border:2px solid orange; padding:20px;">

    <h2> Editar Incidencia Disciplinaria</h2>

    <form method="post" action="{{ url_for('actualizar_incidencia_disciplinaria') }}">

        <input type="hidden" name="id_incidencia" value="{{ editar_incidencia.id_incidencia }}">

        <label>Fecha</label>
        <input type="date" name="fecha" value="{{ editar_incidencia.fecha }}" required min="2000-01-01" max="{{ hoy }}">

        <label>Descripción</label>
        <textarea name="descripcion" rows="3" required>{{ editar_incidencia.descripcion }}</textarea>

        <label>Tipo Disciplinaria</label>
        <input type="text" name="tipo_disciplinaria" value="{{ editar_incidencia.tipo_disciplinaria }}" required>

        <label>Sanción</label>
        <input type="text" name="sancion" value="{{ editar_incidencia.sancion }}" required>

        <!-- CAMBIO HECHO AQUÍ -->
        <label>Bus</label>
        <select name="id_bus" required>
            <option value="">-- Seleccionar bus --</option>
            {% for b in buses %}
                <option value="{{ b.id_bus }}" {% if editar_incidencia.id_bus == b.id_bus %}selected{% endif %}>
                    {{ b.placa }}
                </option>
            {% endfor %}
        </select>

        <label>Estado</label>
        <select name="estado" required>
            <option value="Pendiente" {% if editar_incidencia.estado=='Pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="Resuelta" {% if editar_incidencia.estado=='Resuelta' %}selected{% endif %}>Resuelta</option>
            <option value="Cancelada" {% if editar_incidencia.estado=='Cancelada' %}selected{% endif %}>Cancelada</option>
        </select>

        <br><br>

        <button type="submit">Actualizar</button>
        <a href="{{ url_for('panel_incidencias_disciplinarias') }}" class="btn-sm">Cancelar</a>
    </form>
</div>
{% endif %}

{% endblock %}
